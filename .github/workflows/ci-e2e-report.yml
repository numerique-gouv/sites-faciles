name: ðŸŽ­ CI - E2E visual regression report

# Triggered after ci-e2e.yml completes. Runs in the context of the base repo
# (not the fork), so it has write access to push images and comment on the PR.
on:
  workflow_run:
    workflows: ["ðŸŽ­ CI - E2E tests"]
    types: [completed]

jobs:
  comment-visual-diffs:
    name: Comment visual regression diffs
    if: |
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.pull_requests[0] != null
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Download Playwright diffs
        uses: actions/download-artifact@v4
        with:
          name: playwright-diffs
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ github.token }}
          path: diffs

      - name: Push diff images to branch
        id: push-images
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
        run: |
          BRANCH="pr-${PR_NUMBER}-screenshots"
          git checkout --orphan "$BRANCH"
          git rm -rf --quiet . 2>/dev/null || true
          git clean -fdx -e diffs
          find diffs -name '*.png' -exec git add {} +
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Visual regression diffs for PR #${PR_NUMBER}"
          git push --force origin "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Build PR comment body
        env:
          BRANCH: ${{ steps.push-images.outputs.branch }}
          REPO: ${{ github.repository }}
        run: |
          RAW_BASE="https://raw.githubusercontent.com/${REPO}/${BRANCH}"
          {
            echo "## RÃ©gression visuelle dÃ©tectÃ©e"
            echo ""
            echo "| Test | Avant (main) | AprÃ¨s (PR) | Diff |"
            echo "|------|--------------|------------|------|"
            for expected in $(find diffs -name '*-expected.png' | sort); do
              actual="${expected/-expected/-actual}"
              diff_img="${expected/-expected/-diff}"
              test_name=$(basename "$(dirname "$expected")" | sed 's/-chromium.*//;s/-/ /g')
              echo "| ${test_name} | ![avant](${RAW_BASE}/${actual}) | ![aprÃ¨s](${RAW_BASE}/${expected}) | ![diff](${RAW_BASE}/${diff_img}) |"
            done
            echo ""
            echo "_Generated by Playwright visual regression tests._"
          } > comment_body.md

      - name: Post PR comment
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.workflow_run.pull_requests[0].number }}
        run: |
          gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            -F body=@comment_body.md
